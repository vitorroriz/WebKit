<!DOCTYPE html>
<html>
<head>
<script>
    if (window.testRunner) {
        testRunner.dumpAsText()
        testRunner.waitUntilDone();
    }
    if (window.internals)
        internals.settings.setEnableOpaqueLoadingForMedia(true);
</script>
<script src="../../resources/js-test-pre.js"></script>
</head>
<body>
<video id=video></video>
<script>
    const testId = Math.random() + "";
    const entries = new Set();
    let gotMetadata = false;

    const videoURL = "http://localhost:8000/media/resources/hls/playlist-with-cookie.m3u8?" + testId;
    video.src = "/resources/redirect.py?url=" + encodeURIComponent(videoURL);

    let runTest = function() {
        for (let entry of performance.getEntriesByType('resource')) {
            if (entries.has(entry.name))
                continue;
            entries.add(entry.name);
            if (entry.initiatorType == "video" && entry.name != video.src && entry.name != videoURL)
                testFailed("Unexpected entry: " + entry.name);
            else
                debug(entry.name.replace(testId, ""));
        }

        if (window.testRunner && gotMetadata && entries.size)
            testRunner.notifyDone();
    };
    setInterval(runTest, 100);

    video.addEventListener("loadedmetadata", (e) => {
        gotMetadata = true;
        if (window.testRunner && gotMetadata && entries.size)
            testRunner.notifyDone();
    });
</script>
</body>
</html>

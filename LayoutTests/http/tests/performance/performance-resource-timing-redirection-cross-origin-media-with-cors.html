<!DOCTYPE html>
<html>
<head>
<script>
    if (window.testRunner) {
        testRunner.dumpAsText()
        testRunner.waitUntilDone();
    }
    if (window.internals)
        internals.settings.setEnableOpaqueLoadingForMedia(true);
</script>
<script src="../../resources/js-test-pre.js"></script>
</head>
<body>
<video id=video crossorigin>
<script>
    const testId = Math.random() + "";
    const entries = new Set();
    let gotMetadata = false;
    const expectedEntries = 3;
    let runTest = function() {
        for (let entry of performance.getEntriesByType('resource')) {
            if (entries.has(entry.name))
                continue;
            entries.add(entry.name);
            if (entries.size <= expectedEntries)
                debug(entry.name.replace(testId, ""));
        }

        if (window.testRunner && gotMetadata && entries.size >= expectedEntries)
            testRunner.notifyDone();
    };
    let video = document.querySelector("video");
    setInterval(runTest, 100);

    video.addEventListener("loadedmetadata", (e) => {
        gotMetadata = true;
        if (window.testRunner && gotMetadata && entries.size >= expectedEntries)
            testRunner.notifyDone();
    });
    video.src = "/resources/redirect.py?url=http://localhost:8000/media/resources/hls/playlist-with-cookie.m3u8" + "%3F" + testId;
</script>
</body>
</html>

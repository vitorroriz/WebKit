<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <script src="/resources/testharness.js"></script>
    <script src="/resources/testharnessreport.js"></script>
</head>
<body>
<script>
function with_iframe(url) {
  return new Promise(function(resolve) {
      var frame = document.createElement('iframe');
      frame.srcdoc = url;
      frame.onload = function() { resolve(frame); };
      document.body.appendChild(frame);
    });
}

function toDataUrl(mediaType, payload) {
    let encoded = btoa(payload);
    return `data:${mediaType};base64,${encoded}`;
}

function jsUrl(contents) {
    return toDataUrl('text/javascript', contents);
}

promise_test(async (t) => {
    const workerURL = jsUrl(`
       const workerFunction = async () => {
          const stream = new ReadableStream();
          await stream.cancel({ });
       };
       workerFunction();`);
    const frame = await with_iframe('/');
    const worker = new frame.contentWindow.Worker(workerURL);
    frame.contentWindow.location = '/newpage';
    await new Promise(resolve => setTimeout(resolve, 100));
    frame.remove();
}, "Stop worker while cancelling a readable stream");
</script>
</body>
</html>

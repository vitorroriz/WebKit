<!DOCTYPE HTML>
<html>
<body>
<script src="../../resources/testharness.js"></script>
<script src="../../resources/testharnessreport.js"></script>
<script>

function timeout(milliseconds) {
  return new Promise((resolve) => setTimeout(resolve, milliseconds));
}

promise_test(async function () {
  const events = [];
  const mo1 = new MutationObserver(() => { events.push('mo1'); });
  const element1 = document.createElement('div');
  mo1.observe(element1, {subtree: true, childList: true, attributes: true, characterData: true});
  element1.appendChild(document.createElement('span'));

  const doc2 = document.createElement('template').content.ownerDocument;
  const mo2 = new MutationObserver(() => { events.push('mo2'); });
  const element2 = doc2.createElement('div');
  mo2.observe(element2, {subtree: true, childList: true, attributes: true, characterData: true});
  element2.appendChild(doc2.createElement('span'));

  const mo3 = new MutationObserver(() => { events.push('mo3'); });
  const element3 = document.createElement('div');
  mo3.observe(element3, {subtree: true, childList: true, attributes: true, characterData: true});
  element3.appendChild(document.createElement('span'));

  await timeout(0);

  assert_array_equals(events, ['mo1', 'mo2', 'mo3']);
}, 'MutationObserver callback should be called in the order');

promise_test(async function () {
  const events = [];
  const dialog1 = document.createElement('dialog');
  dialog1.show();
  assert_true(dialog1.hasAttribute('open'));
  dialog1.close();
  dialog1.addEventListener('close', () => events.push('close1'));

  const doc2 = document.createElement('template').content.ownerDocument;
  const dialog2 = doc2.createElement('dialog');
  dialog2.show();
  assert_true(dialog2.hasAttribute('open'));
  dialog2.close();
  dialog2.addEventListener('close', () => events.push('close2'));

  const dialog3 = document.createElement('dialog');
  dialog3.show();
  assert_true(dialog3.hasAttribute('open'));
  dialog3.close();
  dialog3.addEventListener('close', () => events.push('close3'));

  await timeout(0);

  assert_array_equals(events, ['close1', 'close2', 'close3']);
}, '"close" event on a dialog element should fire in the order');

</script>
</body>
</html>
